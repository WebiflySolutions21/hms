<div class="opthal-view-component">
  <div class="opthal-view-wrapper">
    <div class="patient-diagnosis-section">
      <div class="examination mt-4" *ngFor="let item of dropdowns">
        <app-multi-select-dropdown
          [label]="item.heading"
          [key]="item.key"
          [showCheckBox]="item.showPrintToggle"
          [showVoiceInput]="item.showMic"
          [options]="item.options"
          [dropdownId]="item.dropdownId"
          (selectionChanged)="onSelectionChanged($event)"
        ></app-multi-select-dropdown>
      </div>
    </div>

    <div
      *ngFor="let item of forms"
      class="vision-section card shadow-sm p-4 eye-theme"
      [formGroup]="item.form"
    >
      <div class="title text-center mb-4">{{ item.title }}</div>

      <table class="table table-bordered text-center table-striped">
        <thead class="table-eye-header">
          <tr>
            <th></th>
            <th colspan="4">Right Eye (RE)</th>
            <th colspan="4">Left Eye (LE)</th>
          </tr>
          <tr>
            <th></th>
            <th>SPH</th>
            <th>CYL</th>
            <th>AXIS</th>
            <th>Vision</th>
            <th>SPH</th>
            <th>CYL</th>
            <th>AXIS</th>
            <th>Vision</th>
          </tr>
        </thead>
        <tbody>
          <tr [formGroup]="item.form.get('distance')">
            <td><strong>DIST</strong></td>
            <td
              *ngFor="
                let field of [
                  'reSph',
                  'reCyl',
                  'reAxis',
                  'reVision',
                  'leSph',
                  'leCyl',
                  'leAxis',
                  'leVision'
                ]
              "
            >
              <input [formControlName]="field" class="form-control" />
            </td>
          </tr>
          <tr [formGroup]="item.form.get('near')">
            <td><strong>NEAR</strong></td>
            <td
              *ngFor="
                let field of [
                  'reSph',
                  'reCyl',
                  'reAxis',
                  'reVision',
                  'leSph',
                  'leCyl',
                  'leAxis',
                  'leVision'
                ]
              "
            >
              <input [formControlName]="field" class="form-control" />
            </td>
          </tr>
        </tbody>
      </table>

      <!-- ADD Section -->
      <div class="row mt-4" [formGroup]="item.form.get('add')">
        <div class="col-md-3">
          <label>BE ADD</label>
          <input formControlName="be" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>RE ADD</label>
          <input formControlName="re" class="form-control" />
        </div>
        <div class="col-md-3">
          <label>LE ADD</label>
          <input formControlName="le" class="form-control" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button
            class="cal btn btn-outline-primary w-100"
            (click)="calculate(item.form)"
          >
            ðŸ§® Calculate
          </button>
        </div>
      </div>

      <!-- Glass Details -->
      <div class="row mt-3" [formGroup]="item.form.get('glassDetails')">
        <div
          class="col-md-3"
          *ngFor="let detail of ['type', 'color', 'use', 'pd']"
        >
          <label>{{ detail | titlecase }}</label>
          <input [formControlName]="detail" class="form-control" />
        </div>
      </div>

      <button class="btn btn-primary mt-4 w-100" (click)="submitEyeForms()">
        ðŸ’¾ Save Record
      </button>
    </div>

    <!-- WNL Section -->
    <div
      class="vision-section card shadow-sm p-4 eye-theme"
      [formGroup]="wnlForm"
    >
      <h2 class="section-title text-center mb-4">WNL</h2>
      <table class="table table-bordered text-center table-striped">
        <thead class="table-eye-header">
          <tr>
            <th>Title</th>
            <th>RE/OD</th>
            <th>LE/OS</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody formArrayName="entries">
          <tr
            *ngFor="let group of wnlEntries.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Display Title as Heading after Saving -->
            <td *ngIf="!group.get('saved')?.value">
              <input
                formControlName="title"
                class="form-control"
                placeholder="Enter Title"
              />
            </td>
            <td *ngIf="group.get('saved')?.value">
              <h5>{{ group.get("title")?.value }}</h5>
            </td>

            <td>
              <input
                formControlName="re"
                class="form-control"
                placeholder="RE Value"
              />
            </td>
            <td>
              <input
                formControlName="le"
                class="form-control"
                placeholder="LE Value"
              />
            </td>

            <!-- Delete Button -->
            <td>
              <button class="btn btn-danger" (click)="deleteWNLData(i)">
                <i class="fas fa-eye-slash"></i>
                <!-- Eye Close Icon -->
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <button class="btn btn-outline-primary w-100 mb-2" (click)="addWNLData()">
        âž• Add Title Row
      </button>
      <button
        class="btn btn-primary w-100"
        (click)="saveWNLData('yourUniqueId')"
      >
        ðŸ’¾ Save WNL
      </button>
    </div>

    <!-- Existing A-Scan Section -->
    <div
      class="vision-section card shadow-sm p-4 eye-theme"
      [formGroup]="aScanForm"
    >
      <h2 class="section-title text-center mb-4">A-Scan</h2>
      <table class="table table-bordered text-center table-striped">
        <thead class="table-eye-header">
          <tr>
            <th>Title</th>
            <th>RE/OD</th>
            <th>LE/OS</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody formArrayName="entries">
          <tr
            *ngFor="let group of entries.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Display Title as Heading after Saving -->
            <td *ngIf="!group.get('saved')?.value">
              <input
                formControlName="title"
                class="form-control"
                placeholder="Enter Title"
              />
            </td>
            <td *ngIf="group.get('saved')?.value">
              <h5>{{ group.get("title")?.value }}</h5>
            </td>

            <td>
              <input
                formControlName="re"
                class="form-control"
                placeholder="RE Value"
              />
            </td>
            <td>
              <input
                formControlName="le"
                class="form-control"
                placeholder="LE Value"
              />
            </td>

            <!-- Delete Button -->
            <td>
              <button class="btn btn-danger" (click)="deleteAScanEntry(i)">
                <i class="fas fa-eye-slash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <button
        class="btn btn-outline-primary w-100 mb-2"
        (click)="addAScanEntry()"
      >
        âž• Add Title Row
      </button>
      <button
        class="btn btn-primary w-100"
        (click)="saveAScanData('yourUniqueId')"
      >
        ðŸ’¾ Save A-Scan
      </button>
    </div>
    <div class="medicine-prescription" #prescriptionSection>
      <app-prescription-table
        [prescriptionData]="prescriptionData"
        (prescriptionUpdated)="onPrescriptionUpdate($event)"
      ></app-prescription-table>
    </div>

    <div
      class="surgery-section card shadow-sm p-4 eye-theme"
      [formGroup]="surgeryForm"
    >
      <h2 class="section-title text-center mb-4">Surgery Details</h2>

      <!-- Surgery Advice and Plan Date -->
      <div class="row">
        <div class="col-md-6">
          <label>Surgery Advice</label>
          <input formControlName="surgeryAdvice" class="form-control" />
        </div>
        <div class="col-md-6">
          <label>Surgery Plan Date</label>
          <input
            type="date"
            formControlName="surgeryPlanDate"
            class="form-control"
          />
        </div>
      </div>

      <!-- Surgery Status -->
      <div class="row mt-3">
        <div class="col-md-6">
          <label>Surgery Status</label>
          <input formControlName="surgeryStatus" class="form-control" />
        </div>
      </div>

      <!-- Surgery Details for Right and Left Eye -->
      <table class="table table-bordered text-center table-striped mt-4">
        <thead>
          <tr>
            <th>Surgery</th>
            <th>Right Eye</th>
            <th>Left Eye</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Admission</strong></td>
            <td>
              <input
                formControlName="rightEyeAdmission"
                class="form-control"
                type="date"
              />
            </td>
            <td>
              <input
                formControlName="leftEyeAdmission"
                class="form-control"
                type="date"
              />
            </td>
          </tr>
          <tr>
            <td><strong>Surgery</strong></td>
            <td>
              <input
                formControlName="rightEyeSurgery"
                class="form-control"
                type="date"
              />
            </td>
            <td>
              <input
                formControlName="leftEyeSurgery"
                class="form-control"
                type="date"
              />
            </td>
          </tr>
          <tr>
            <td><strong>Discharge</strong></td>
            <td>
              <input
                formControlName="rightEyeDischarge"
                class="form-control"
                type="date"
              />
            </td>
            <td>
              <input
                formControlName="leftEyeDischarge"
                class="form-control"
                type="date"
              />
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Lens and Power Details for Right and Left Eye -->
      <table class="table table-bordered text-center table-striped mt-4">
        <thead>
          <tr>
            <th>Lens</th>
            <th>Right Eye</th>
            <th>Left Eye</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Lens</strong></td>
            <td>
              <input formControlName="rightEyeLens" class="form-control" />
            </td>
            <td>
              <input formControlName="leftEyeLens" class="form-control" />
            </td>
          </tr>
          <tr>
            <td><strong>Power</strong></td>
            <td>
              <input formControlName="rightEyePower" class="form-control" />
            </td>
            <td>
              <input formControlName="leftEyePower" class="form-control" />
            </td>
          </tr>
          <tr>
            <td><strong>Batch</strong></td>
            <td>
              <input formControlName="rightEyeBatch" class="form-control" />
            </td>
            <td>
              <input formControlName="leftEyeBatch" class="form-control" />
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Other Items, Final Diagnosis, Condition on Discharge, and Advice/Remark/Plan -->
      <div class="row mt-4">
        <div class="col-md-6">
          <label>Other Item</label>
          <input formControlName="otherItem" class="form-control" />
        </div>
        <div class="col-md-6">
          <label>Final Diagnosis</label>
          <input formControlName="finalDiagnosis" class="form-control" />
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <label>Condition on Discharge</label>
          <input formControlName="conditionOnDischarge" class="form-control" />
        </div>
        <div class="col-md-6">
          <label>Advice/Remark/Plan</label>
          <input formControlName="adviceRemarkPlan" class="form-control" />
        </div>
      </div>

      <button
        class="btn btn-primary mt-4 w-100"
        (click)="submitSurgeryDetails()"
      >
        ðŸ’¾ Save Surgery Details
      </button>
    </div>
  </div>
</div>
